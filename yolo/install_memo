https://qiita.com/SwitchBlade/items/5d5bc645822229ee0ed9


git clone https://github.com/WongKinYiu/yolov7.git

miyakz@lily2:~$ ubuntu-drivers devices
WARNING:root:_pkg_get_support nvidia-driver-390: package has invalid Support Legacyheader, cannot determine support level
== /sys/devices/pci0000:00/0000:00:03.1/0000:07:00.0 ==
modalias : pci:v000010DEd0000128Bsv000019DAsd00001422bc03sc00i00
vendor   : NVIDIA Corporation
model    : GK208B [GeForce GT 710]
driver   : nvidia-driver-470-server - distro non-free
driver   : nvidia-driver-418-server - distro non-free
driver   : nvidia-driver-470 - distro non-free recommended
driver   : nvidia-driver-390 - distro non-free
driver   : nvidia-driver-450-server - distro non-free
driver   : xserver-xorg-video-nouveau - distro free builtin

miyakz@lily2:~$ 

a@ai03:~$ sudo apt install -y --no-install-recommends nvidia-driver-460

この後、新しいカーネルが出来た様子なので、ai03をリブート

00:01.0 VGA compatible controller: Red Hat, Inc. QXL paravirtual graphic card (r
ev 04)
けども、ＶＭからはこんなグラフィックカードが見えるけど良いのかな？
とりあえず、ＣＵＤＡ入れてみる。

https://developer.nvidia.com/cuda-downloads?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=20.04&target_type=deb_network

案内どおりに入れて
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
sudo dpkg -i cuda-keyring_1.0-1_all.deb
sudo apt-get update
sudo apt-get -y install cuda



a@ai03:~$ wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
--2022-10-18 15:54:22--  https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
Resolving developer.download.nvidia.com (developer.download.nvidia.com)... 152.199.39.144
Connecting to developer.download.nvidia.com (developer.download.nvidia.com)|152.199.39.144|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 4328 (4.2K) [application/x-deb]
Saving to: ‘cuda-keyring_1.0-1_all.deb’

cuda-keyring_1.0-1_ 100%[===================>]   4.23K  --.-KB/s    in 0s      

2022-10-18 15:54:22 (311 MB/s) - ‘cuda-keyring_1.0-1_all.deb’ saved [4328/4328]

a@ai03:~$ sudo dpkg -i cuda-keyring_1.0-1_all.deb
Selecting previously unselected package cuda-keyring.
(Reading database ... 72918 files and directories currently installed.)
Preparing to unpack cuda-keyring_1.0-1_all.deb ...
Unpacking cuda-keyring (1.0-1) ...
Setting up cuda-keyring (1.0-1) ...
a@ai03:~$ 
a@ai03:~$ ls
cuda-keyring_1.0-1_all.deb  ml_study  token
a@ai03:~$ du -m cuda-keyring_1.0-1_all.deb 
1	cuda-keyring_1.0-1_all.deb
a@ai03:~$ sudo apt-get update
Get:1 https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64  InRelease [1,581 B]
Get:2 https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64  Packages [705 kB]
Hit:3 http://jp.archive.ubuntu.com/ubuntu focal InRelease          
Hit:4 http://jp.archive.ubuntu.com/ubuntu focal-updates InRelease
Hit:5 http://jp.archive.ubuntu.com/ubuntu focal-backports InRelease
Hit:6 http://jp.archive.ubuntu.com/ubuntu focal-security InRelease
Fetched 707 kB in 1s (925 kB/s)
Reading package lists... Done
a@ai03:~$ sudo apt-get -y install cuda
Reading package lists... Done
Building dependency tree       
Reading state information... Done
Some packages could not be installed. This may mean that you have
requested an impossible situation or if you are using the unstable
distribution that some required packages have not yet been created
or been moved out of Incoming.
The following information may help to resolve the situation:

The following packages have unmet dependencies:
 cuda : Depends: cuda-11-8 (>= 11.8.0) but it is not going to be installed
E: Unable to correct problems, you have held broken packages.
a@ai03:~$ 


前途多難なり。。。


https://zenn.dev/190ikp/articles/vagrant_libvirt_gpu
これをやる必要があるのか。。。？かなり難しそうなり。
lily2に影響があるのは勘弁してほしい。


a@ai03:~/yolov7$ python3 test.py --data data/coco.yaml --img 640 --batch 32 --conf 0.001 --iou 0.65 --device 0 --weights yolov7.pt --name yolov7_640_val --device cpu

とりあえず、cpuでいけそうだ。

val: Scanning 'coco/val2017' images and labels... 4952 found, 48 missing, 0 empty, 0 corrupted: 100%|███████████| 5000/5000 [00:02<00:00, 1986.01it/s]
val: New cache created: coco/val2017.cache
               Class      Images      Labels           P           R      mAP@.5  mAP@.5:.95:   0%|                           | 0/157 [00:00<?, ?it/s]/home/a/.local/lib/python3.8/site-packages/torch/functional.py:478: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at  ../aten/src/ATen/native/TensorShape.cpp:2895.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
               Class      Images      Labels           P           R      mAP@.5  mAP@.5:.95:   6%|█                  | 9/157 [02:49<46:41, 18.93s/it]




               Class      Images      Labels           P           R      mAP@.5  mAP@.5:.95:  66%|███████████▏     | 103/157 [34:40<21:18, 23.67s/it]Killed
a@ai03:~/yolov7$ 


けど、killedで殺されてしまった。どうにも上手く動作しないね！yolo7は。。。

detectってやつは上手く動いた。
a@ai03:~/yolov7$ python3 detect.py --source inference/images/horses.jpg --weights yolov7-e6e.pt --conf 0.25 --img-size 1280 --device cpu
Namespace(agnostic_nms=False, augment=False, classes=None, conf_thres=0.25, device='cpu', exist_ok=False, img_size=1280, iou_thres=0.45, name='exp', no_trace=False, nosave=False, project='runs/detect', save_conf=False, save_txt=False, source='inference/images/horses.jpg', update=False, view_img=False, weights=['yolov7-e6e.pt'])
YOLOR 🚀 v0.1-115-g072f76c torch 1.12.1+cu102 CPU

Downloading https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-e6e.pt to yolov7-e6e.pt...
100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 290M/290M [00:45<00:00, 6.72MB/s]

Fusing layers... 
Model Summary: 792 layers, 151687420 parameters, 817020 gradients
 Convert model to Traced-model... 
 traced_script_module saved! 
 model is traced! 

/home/a/.local/lib/python3.8/site-packages/torch/functional.py:478: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at  ../aten/src/ATen/native/TensorShape.cpp:2895.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
5 horses, Done. (6892.7ms) Inference, (4.6ms) NMS
 The image with the result is saved in: runs/detect/exp2/horses.jpg
Done. (9.141s)
a@ai03:~/yolov7$ 

